## 4   问题4

问题4的核心目标是以染色体非整倍体为判定标签，综合多种因素，构建较为可靠的异常判定模型。该模型应当具有良好的临床应用性，既能够判定是否有异常风险，有能给出良好的解释性。

### 4.1 确定参与分析的因素

对判定模型最为重要的因素是13、18、21号染色体的Z值，根据题目材料提供的医学领域知识背景，可以通过Z值是否异常来对胎儿是否异常做出初步判定。
其次是测序质量相关的因素，包括原始测序总读段数、被过滤读段比例、唯一比对读段数（比例）、GC含量、13/18/21号染色体的GC含量。这些因素体现测序质量的好坏，测序质量对能够判定异常的把握也有所影响。
第三是孕妇本身的因素。包括：年龄，BMI，IVF妊娠方式，怀孕次数、生产次数。这些因素体现在孕妇自身，虽然和基因相关性较弱，但仍然有可能对胎儿异常有影响，需要纳入分析。
此外还有其他尚不能确定有直接影响或影响机制的因素，包括X染色体Z值和浓度。为保证模型的完备性，需要纳入分析。

### 4.2 数据预处理

将三种异常合并为统一的“异常”状态，并标记为1，正常标记为0.异常样本仅占10%左右，在后续需要进行过采样。受孕方式标记成两类，自然受孕标记为0，IVF标记为1.参照临床定义方式，将35岁以上标记为高龄（1），35岁及以下标记为0.通过0/1标记，对上述几个因素进行了简化处理。
将所有连续型变量进行标准化处理，避免量纲影响该因素在模型中的权重。
进行方差分析ANOVA，将相关性极低的若干变量剔除。但仅基于相对的相关性强弱来选择剔除。该步骤是为了减少不必要的复杂程度。

### 4.3 合成样本

因为附件数据中异常样本占比过低，仅占10%左右，直接使用当前数据进行建模容易导致模型偏向正常样本，异常样本漏检率较高，不符合临床需要。为了提高模型的检测能力，需要对异常样本进行过采样。
因为很多异常样本可能较为稀疏，所以需要有差别地进行异常样本合成。考虑使用ADASYN方法平衡训练集中正常和异常样本的比例。
首先进行数据划分，按7:3的比例划分训练集和测试集。之后按照ADASYN方法，对训练集中异常样本进行过采样合成，使得异常样本：正常样本能够达到约4：6的比例。
ADASYN基于SMOTE方法，通过自适应性合成新样本来增加训练集中异常样本的数量，同时以更大权重合成密度低的异常样本。具体过程如下：
①计算少数类样本密度。对训练集中所有异常样本，计算每个异常样本5个最邻近样本中异常样本的数量，记为$D_i$。计算$\rho _i=\frac{D_i}{5}$作为该样本所在处的异常样本密度。
②计算样本合成权重。对训练集中所有异常样本，根据其异常样本密度，计算其合成权重$W_i$：
$W_i=\frac{\rho _i}{\sum{\rho}}$
③合成样本。计算为了达到正常样本与异常样本的目标比例，需要合成的新样本数量$N$。然后对训练集中每个异常样本$x_i$，选取距离最近的3个异常样本中随机一个$x_j$，计算其与$x_i$的差值向量$v$，合成一个新样本$x_{i'}$：
$x_{i'}=x_i+\alpha v$
其中$\alpha$为落在(0,1)的随机数，服从均匀分布。对异常点$x_i$重复该过程，直到合成$N\times W_i$个新异常点。
④重复步骤③，直到合成足够多的新样本。

### 4.4 训练多种模型

可用于医疗诊断领域的模型相当多，此处决定对多个模型均予以尝试，选出效果最好的或是给出多个模型综合决策。对于模型给出的预测染色体异常概率，以0.7为阈值，高于0.7报告预警。

#### 4.4.1 随机森林

随机森林因为其良好的分类性能和抗过拟合能力，被广泛应用于医疗诊断领域。首先设置合适的树数量、最大深度、最小样本分裂，然后用训练集5折交叉验证调参，以F1值为优化目标。
评估随机森林模型的性能。

#### 4.4.2 XGBoost

XGBoost是一种基于决策树的集成学习算法，通过串行训练多个决策树，让每个决策树纠正前面决策树的错误，最终加权得到更强的分类器。XGBoost被广泛应用于分类和回归任务，优势在于速度快、性能好、抗过拟合能力强。
首先设置合适的参数：学习率、树数量、最大深度、子样本比例、colsample_bytree，然后用Focal Loss替代默认的交叉熵损失函数，用训练集训练模型，用测试集验证召回率和精确率，评估模型性能。

#### 4.4.3 LightGBM

LightGBM是XGBoost的进一步优化模型，以其高训练速度和低内存占用，适合处理大规模数据集，是工业界处理结构化数据的主流算法之一。LightGBM首创“按叶生长”策略，每次分裂时只考虑分裂后增益最大的叶子节点，而不是每一层所有叶子节点都进行分裂，同时通过直方图算法压缩特征空间，从而大幅提升了效率。
在本题中，该模型和大样本量适配。需要首先设定参数包括学习率、树数量、最大深度、叶子节点数、bagging_fraction、feature_fraction。损失函数沿用Focal Loss，训练后输出特征重要性用于解释模型。

### 4.5 评估模型

在本题的语境下，需要结合医疗场景对评估模型的标准做出强调。对于染色体异常疾病，漏诊是代价高昂的，所以宁愿有一些假正例，也不能有漏正例。需要优先保证异常召回率足够，其次平衡精确率，尽量减少误诊。
期望满足临床应用场景的模型应当呈现出高异常召回率（90%以上）和足够的精确率（70%以上）。从而及时发现并报告胎儿异常风险，并减少不必要的医疗干预。
