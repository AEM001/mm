## 0   数据处理
### 0.1 数据清洗
在开始后续分析之前需要事先剔除表格中存在的异常值。考虑到数据量大、数据种类多，决定使用$3\sigma$原则剔除异常值。
经过筛选，适合使用本方法清洗的指标包括表格中的L,M,N,O,P,AA列。首先计算这些指标的平均值和标准差，然后根据$3\sigma$原则，剔除在平均值三倍标准差之外的异常值。对于不同指标，剔除标准有所差别。L、M、O、P列需要剔除低于$3\sigma$的异常值，因为这些检测数据过低导致检测结果可信度差。N、AA列需要剔除高于$3\sigma$的异常值，因为这些检测数据高说明有效的读段偏少，检测可信度差。
特别需要注意的是，面对问题1等探索正常生命规律的问题时，需要剔除所有胎儿是否健康被标记为否的数据，否则异常数据将干扰正常分析。
### 0.2 数据预处理
需要对表格中一些变量的格式进行统一化以便定量分析。例如检测孕周数据需要统一为小数周数而非保留周+日格式。
唯一比对读段数数据需要转化为占总读段数的比例。连续且需要参加后续建模的变量需要进行标准化以消除量纲影响，如孕周、BMI、总读段数、唯一比对读段数（比例）、染色体Z值。其中染色体Z值建议重新标准化的原因是其本身是基于正常对照群体计算的，而非本数据集。标准化的公式为：
$Z=\frac{x-\mu}{\sigma}$
其中$x$为原始数据，$\mu$为均值，$\sigma$为标准差。

## 1   问题1
### 1.1 相关性分析
按照题目要求，首先分别检验Y染色体浓度与孕妇孕周数和BMI两个指标的相关性。首先绘制散点图，初步观察相关性强弱、趋于线性还是非线性。若观察到线性关系不强，考虑使用Spearman秩相关系数进行检验，否则可以使用Pearson相关系数。
检验得到结论主要包括单个指标的关联方向（正/负相关）和关联强度（弱/中/强相关），用于后续分析。
### 1.2 关系建模
考虑建立Y染色体-孕周数和BMI的关系模型。首先需要筛选数据。显然，由于只有男胎有Y染色体，所以只使用男胎数据进行建模。其次，只考虑孕周在10-25周的样本，因为题目强调在10-25周可以检测性染色体浓度。
首先基于相关性分析结果，构建线性回归模型作为基础模型。因变量为Y染色体浓度，自变量为孕周数和BMI。基础模型表达式如下：
$c_Y=\beta _0+\beta _1\times W+\beta _2\times B+\varepsilon$
其中$c_Y$为Y染色体浓度，$\beta _0$为截距，$\beta_1$为孕周数的回归系数，$W$为孕周数，$\beta_2$为BMI的回归系数，$B$表示BMI，$\varepsilon$为误差项。
使用OLS估计系数，并计算模型的p值和拟合优度$R^2$，分析拟合效果。（此时大概率拟合效果差）
因为拟合效果差，考虑使用非线性模型进行拟合，并加入交互项提高拟合效果。考虑使用逐步回归筛选合适的二次项和交互项加入模型中。
备选的项包括$W^2$, $W\times B$, $B^2$。每次添加一项，并使用AIC准则进行模型选择。直到无法再添加新项或AIC值增加/系数不显著。
### 1.3 显著性检验
得到最终模型之后，再次计算p值和拟合优度$R^2$，分析拟合效果得到多少提升。同时可以根据系数取值对模型加以临床意义解释。

## 2   问题2
### 2.1 BMI分组
首先观察到孕妇BMI指数和孕周呈现正相关性，因为随着孕周增加，孕妇体重会增加。为了实现较为稳定的BMI分组，考虑以孕妇达到Y染色体浓度4%的时间的BMI为分组对象。
首先需要为每个孕妇分别建立BMI-孕周的关系模型，以将两个变量合成一个。需要注意的是孕周必须满足为10-25，按照要求去除部分数据之后，仅对数据量足够的孕妇进行建模。观察到基本呈现为线性关系，所以线性拟合模型：
$B_i\left( t \right) =\alpha _i+\beta _i\times t$
其中$B_i$为第$i$个孕妇的BMI，$t$为孕周，$\alpha_i$为截距，$\beta_i$为孕周的回归系数。用最小二乘法估计系数，对于拟合效果差的可选用二次模型，但这一选择可能加大后续计算量。
问题1中已经得到了Y染色体浓度-孕周的关系模型，先将每个孕妇的B-t模型带入问题1模型消去B，然后取$c_Y=4\%$，解出$t_i$，同时算出预测BMI并与$t_i$配对。
之后进行分组。首先验证BMI和达标孕周的相关性，若相关性较强，可直接按照BMI进行分组。绘制散点图并计算Spearman相关系数，验证相关性较强。
使用K-means聚类方法进行分组。绘制聚类数k-组内误差平方和曲线，使用肘部法则确定k。完成聚类并将结果作为BMI的分组结果。


### 2.2 最佳时点确定
基于BMI分组的结果，确定每组的最佳时点。为了实现风险的最小化，需要时点选取尽可能早；而为了保证Y染色体浓度能够达标，需要时点选取尽可能晚。所以存在两个因素需要相互权衡，考虑将本题视为一个优化问题。
首先量化检测过晚导致的治疗窗口期缩短的风险值，直接用选取的时点量化风险：
$Risk_i=T_i$
其中$Risk_i$为第$i$组BMI整体的风险值，$T_i$为第$i$组BMI数据选取的最佳时点。
其次量化检测太早导致的组内Y染色体浓度不达标的损失，用组内不达标率来量化：
$Loss_i=100\,R_i$
其中$R_i$为第$i$组BMI整体的不达标率，乘上系数100为了将Risk和Loss基本调整到同一量级上。
接下来建立优化模型，目标是最小化潜在风险和组内不达标率：
$\min\ F(T_i)=\lambda\times Risk(T_i)+(1-\lambda)\times Loss\big(R_i(T_i)\big)$
其中$\lambda$为权衡系数，取值范围为0-1。
约束条件包括：
$Risk(T_i)=T_i$
$Loss\big(R_i(T_i)\big)=100\,R_i(T_i)$
$R_i(T_i)=\dfrac{N_{i,\ \text{不达标}}}{N_i}\times 100\%$
$10\le T_i\le 25$
$R_i(T_i)\le10\%$
在12周内发现风险低，而12周以后发现风险高。所以$\lambda$基础情况取0.8（12周以后，注重尽早发现），若解得$T_i$值早于12周，可将$\lambda$取0.5再次优化，尝试提高达标率因为选取时点已经足够早。
求解建议以0.5周步长进行尝试。若复杂度较低也可缩短步长。

### 2.3 检测误差分析
因为检测过程中准确性不能保证非常完美，所以会出现Y染色体浓度测量不准的情况，并进而导致最佳时点选取的不准确。因此考虑对附件数据中的Y染色体浓度数据添加随机的误差，并重新计算最佳时点，分析结果的稳定性。
对于BMI分组结果中每一组的所有样本的Y染色体浓度数据，分别添加服从正态分布的随机误差：
$c_{扰动}=c_{原始}\times (1+0.05r)$
其中r为[-1,1]区间内的均匀随机数。
不对BMI重新进行分组，直接使用2.2中的优化模型进行计算。重复一定次数（建议为例如1000次），得到最终结果时点的分布，计算均值和标准差。与扰动前结果进行对比，从而分析结果的稳健性。