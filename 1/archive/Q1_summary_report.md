# 第一问总结报告（统一比例标度 + 分组交叉验证）

本报告基于脚本 `1/fractional_logit_improved.py` 的最新一次运行（见 `1/fractional_logit_improved_results/`），严格引用本次运行输出的具体数值，评估“分数 logit（GLM Binomial + logit）+ 低自由度样条交互 + 分组CV”的实施正确性与效果。

---

## 一、数据与方法概述

- 脚本：`1/fractional_logit_improved.py`
- 响应变量：`Y染色体浓度`（比例标度，边界裁剪后范围 [0.010004, 0.234218]；4%阈值=0.04）
- 关键自变量：`孕周_标准化`、`BMI_标准化`、`年龄_标准化`，以及测序质量变量（`总读段数_标准化`、`比对比例_标准化`、`重复读段比例_标准化`、`唯一比对读段比例_标准化`、`GC含量_标准化`、`过滤读段比例_标准化`）
- 统计框架：`statsmodels.GLM(family=Binomial, link=logit)`
- 非线性：`patsy.bs` 低自由度样条（df ∈ {3,4}），并构建 `孕周×BMI` 的样条张量交互（`max_interactions ∈ {9,12}`）
- 验证：`GroupKFold(n_splits=5)`，按 `孕妇代码`分组交叉验证，防止数据泄漏
- 调参：网格搜索参数 `{df_gest, df_bmi, alpha, max_interactions}`，以 `CV RMSE` 最小为准

---

## 二、调参与交叉验证结果

- 网格搜索总组合数：32（详见 `1/fractional_logit_improved_results/grid_search_results.csv`）
- 最优参数（基于CV RMSE）：
  - `df_gest = 3`
  - `df_bmi = 3`
  - `max_interactions = 9`
  - `alpha = 0.0`（本次无正则更优）
- 分组交叉验证（最优参数）摘要：
  - `CV MAE = 0.025837 ± 0.001398`
  - `CV RMSE = 0.032333 ± 0.002161`
  - `CV R² = 0.0611 ± 0.0430`

说明：在统一的“比例标度”上，最优模型展现出小幅度但稳定的解释度与泛化性能（R²≈0.06），符合此前对信号强度较弱的判断，且较原GAM方案更稳健（统一标度下的对比可参考 `1/unified_scale_comparison_results/`）。

---

## 三、最终模型（以最优参数在全数据拟合）

- 训练集性能（见 `1/fractional_logit_improved_results/improved_model_summary.txt`）：
  - `MAE = 0.024867`
  - `RMSE = 0.031209`
  - `R² = 0.1455`
  - `AIC = 454.09`
  - `BIC = 567.11`
  - `Log-Likelihood = -204.05`
  - `Pseudo R² (McFadden) = 0.0058`
  - `特征数(不含截距) = 22`
  - `参数数量 = 23`

备注：训练 R² 高于 CV R²，这与轻度过拟合的常见现象一致。泛化表现应以“分组CV指标”为准。

---

## 四、方法学正确性与第一问结论

- 已满足第一问的全部方法学要求：
  - __比例响应的正确处理__：目标变量保持在比例标度，使用 GLM Binomial + logit，预测天然落在 (0,1)
  - __纳入测序质量变量__：控制技术变异和系统性偏差
  - __非线性与交互__：通过低自由度样条以及 `孕周×BMI` 交互捕获关键非线性结构
  - __防止数据泄漏__：按 `孕妇代码`进行分组交叉验证
- __效果判断（统一比例标度 + 分组CV）__：
  - 最优模型的 `CV RMSE ≈ 0.0323`，`CV R² ≈ 0.061`，在当前数据下属于“小幅但可信”的改进与解释度。
  - 更高自由度或更强正则在本次搜索中未优于 `df=3` 与 `alpha=0` 的配置。

综合结论：第一问的“正确模型框架落地 + 稳健验证 + 可解释评估”已经完成并达标；现阶段不建议继续在复杂度上扩张，收益有限且风险提升。后续若需进一步优化，应以数据扩增或新增高信息量的协变量为主，而非继续堆叠样条或交互。

---

## 五、可复用与交付物

- 运行脚本：
  - `python3 1/fractional_logit_improved.py`
- 关键输出目录与文件：
  - `1/fractional_logit_improved_results/grid_search_results.csv`（全部参数组合的分组CV结果）
  - `1/fractional_logit_improved_results/improved_model_summary.txt`（最优参数、训练指标、Pseudo R²、AIC/BIC、最优CV指标摘要）

如需在报告中加入“最终模型的系数层面摘要（以便变量层面的解读）”，可以在当前脚本中追加导出 `final_model.summary()` 的文本段落。我可以为你补充该部分（可选）。

---

## 六、与初始 GAM 的对比（统一“比例标度”，分组CV）

为避免跨标度比较的误导，以下对比基于脚本 `1/unified_scale_comparison.py` 的输出（见 `1/unified_scale_comparison_results/unified_comparison_report.txt`），在统一的“比例标度”上、采用按孕妇代码的分组交叉验证：

- 分数logit（样条交互）：

  - CV RMSE = 0.032426 ± 0.002157
  - CV R² = 0.0555 ± 0.0466
  - CV MAE = 0.025940 ± 0.001427
- 分数logit（基础线性）：

  - CV RMSE = 0.032939 ± 0.002631
  - CV R² = 0.0271 ± 0.0567
  - CV MAE = 0.026528 ± 0.001685
- GAM（代表性三种配置，Gaussian族，比例标度）：

  - GAM_交互_WB：CV RMSE = 0.033818 ± 0.002408，CV R² = -0.0374 ± 0.1651
  - GAM_简化：CV RMSE = 0.033893 ± 0.003535，CV R² = -0.0421 ± 0.2127
  - GAM_基准：CV RMSE = 0.034065 ± 0.002639，CV R² = -0.0531 ± 0.1791

结论：在统一“比例标度”与分组CV下，分数logit（样条交互）优于 GAM，平均相对 RMSE 改进约 3.7%。此外，分数logit 获得正的 CV R²（≈0.056），而上述 GAM 配置的 CV R² 为负，显示分数logit 在泛化层面更稳健。

注：`pyGAM` 与 `statsmodels.GLM` 的 AIC/伪R²口径不同，且不建议跨框架直接比较 AIC；公平对比应以“统一标度 + 分组CV”的误差类指标（RMSE/MAE/R²）为准。

---

## 七、为何 CV R² 值较小（≈0.06）

- 数据信号固有限制：本次运行的 `Y染色体浓度` 范围 `[0.010, 0.234]`，均值约 `0.078`，有效动态范围偏窄，目标方差较小时，R² 天然受限。
- 关键自变量与目标的相关性较弱：既往相关分析显示，孕周与 BMI 与目标的线性相关度不高（例如孕周≈0.10，BMI≈-0.17 的量级），非线性项虽可提升，但幅度有限。
- 技术噪声与未观测混杂：即使已纳入测序质量变量并做质量过滤，仍可能存在实验批次效应、样本处理差异等未完全捕获的变异，稀释可解释信号。
- 比例数据的方差结构：分数logit匹配了均值-方差关系，但当真实噪声呈现过度离散或异方差时（例如组间差异大），常规GLM的解释率会偏低。

尽管 R² 较小，但“正的 CV R²（≈0.06）+ 较低的 CV RMSE（≈0.0323）”意味着模型在统一标度下确实优于“用样本均值做预测”的基准，属于“小幅但可信”的改进。同时，相比 R²，围绕临床阈值（如 4%）的判别与校准往往更能反映实际应用价值。

---

## 八、基于两份文件的直接对比要点（中文补充）

- 参考文件：
  - `1/gam_enhanced_results/best_model_summary.txt`（GAM 最优模型 M6_WB_focused 的训练摘要，Gaussian 标度）
  - `1/y_distribution_analysis/statistical_summary_fixed.txt`（`Y染色体浓度` 的 logit 分布与相关统计，非模型评估）

- 关键事实：
  - GAM 文件中的伪R²=0.1828 来自高斯标度的训练拟合，且未采用“按孕妇分组”的交叉验证；不可与“比例标度 + 分组CV”的结果直接比较。
  - 分布统计文件显示：`Y` 的 logit 分布拒绝正态（Shapiro p≈2.13e-10），且与孕周/BMI/年龄的相关系数偏弱（≈0.099、-0.171、-0.066），支持采用 Binomial+logit 的分数logit，并解释了为何 CV R² 会偏小。

- 新方法（分数logit，统一比例标度 + 分组CV）的本次运行结果：
  - 最优参数：`df_gest=3, df_bmi=3, max_interactions=9, alpha=0.0`
  - 分组CV：`CV MAE=0.025837 ± 0.001398`，`CV RMSE=0.032333 ± 0.002161`，`CV R²=0.0611 ± 0.0430`
  - 训练集（说明用）：`MAE=0.024867`，`RMSE=0.031209`，`R²=0.1455`，`AIC=454.09`，`BIC=567.11`，`McFadden伪R²=0.0058`

- 公平对比下的结论（统一比例标度 + 分组CV）：
  - 分数logit（样条交互）优于 GAM：CV RMSE 约改善 3.7%，且分数logit 的 CV R² 为正（≈0.06），而代表性 GAM 配置的 CV R² 为负。
  - 因此，分数logit 在“方法学匹配度与泛化稳定性”上优于 GAM；尽管解释度不高，但已实现“小幅且可信”的提升。
